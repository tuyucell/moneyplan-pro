import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:invest_guide/core/constants/colors.dart';
import 'package:invest_guide/core/utils/responsive.dart';
import 'dart:async';
import 'package:invest_guide/services/api/invest_guide_api.dart';
import 'package:invest_guide/core/i18n/app_strings.dart';
import 'package:invest_guide/core/providers/language_provider.dart';

import 'package:invest_guide/features/shared/widgets/economic_calendar_widget.dart';
import 'package:invest_guide/features/search/presentation/widgets/macro_indicators_widget.dart';
import 'package:invest_guide/core/router/app_router.dart';

class MarketsPage extends ConsumerStatefulWidget {
  const MarketsPage({super.key});

  @override
  ConsumerState<MarketsPage> createState() => _MarketsPageState();
}

class _MarketsPageState extends ConsumerState<MarketsPage> {
  final ScrollController _scrollController = ScrollController();
  List<dynamic> _newsList = [];
  bool _isNewsLoading = true;

  @override
  void initState() {
    super.initState();
    _loadAllData();
  }

  Future<void> _loadAllData() async {
    try {
      final news = await InvestGuideApi.getNews(limit: 10);
      if (mounted) {
        setState(() {
          _newsList = news;
          _isNewsLoading = false;
        });
      }
    } catch (e) {
      debugPrint('News Fetch Error: $e');
      if (mounted) setState(() => _isNewsLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final language = ref.watch(languageProvider);
    final lc = language.code;

    return Scaffold(
      backgroundColor: AppColors.background(context),
      body: CustomScrollView(
        controller: _scrollController,
        slivers: [
          SliverAppBar(
            pinned: true,
            floating: true,
            backgroundColor: AppColors.surface(context),
            elevation: 0,
            title: Text(
              AppStrings.tr(AppStrings.pageMarkets, lc),
              style: TextStyle(
                color: AppColors.textPrimary(context),
                fontSize: 22,
                fontWeight: FontWeight.w800,
                letterSpacing: -0.5,
              ),
            ),
            centerTitle: false,
            actions: [
              const SizedBox(width: 8),
            ],
            bottom: PreferredSize(
              preferredSize: const Size.fromHeight(1),
              child: Container(
                height: 1,
                color: AppColors.border(context),
              ),
            ),
          ),

          SliverToBoxAdapter(
            child: _MarketTickerWidget(lc: lc),
          ),

          SliverToBoxAdapter(
            child: Container(
              padding: const EdgeInsets.fromLTRB(16, 12, 16, 4),
              child: InkWell(
                onTap: () => context.push('/search'),
                borderRadius: BorderRadius.circular(10),
                child: Container(
                  height: 40,
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: AppColors.surface(context),
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(color: AppColors.border(context).withValues(alpha: 0.5)),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.search, size: 18, color: AppColors.textSecondary(context)),
                      const SizedBox(width: 8),
                      Text(
                        AppStrings.tr(AppStrings.searchHint, lc),
                        style: TextStyle(fontSize: 13, color: AppColors.textSecondary(context)),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
          
          SliverToBoxAdapter(
            child: const EconomicCalendarWidget(),
          ),

          SliverToBoxAdapter(
            child: const MacroIndicatorsWidget(),
          ),

          SliverToBoxAdapter(
            child: _LatestNewsWidget(
              news: _newsList,
              isLoading: _isNewsLoading,
              lc: lc,
            ),
          ),

          SliverToBoxAdapter(
            child: Padding(
              padding: const EdgeInsets.fromLTRB(20, 32, 20, 16),
              child: Text(
                AppStrings.tr(AppStrings.headerInvestTools, lc),
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w800,
                  color: AppColors.textPrimary(context),
                  letterSpacing: -0.5,
                ),
              ),
            ),
          ),

            SliverPadding(
              padding: context.adaptivePadding,
              sliver: SliverGrid(
                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: context.isTablet ? 3 : 2, 
                  childAspectRatio: context.isTablet ? 1.5 : 1.3,
                  crossAxisSpacing: context.isTablet ? 16 : 12,
                  mainAxisSpacing: context.isTablet ? 16 : 12,
                ),
              delegate: SliverChildListDelegate([
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catCrypto, lc),
                  subtitle: AppStrings.tr(AppStrings.catCryptoDesc, lc),
                  icon: Icons.currency_bitcoin,
                  color: AppColors.crypto,
                  onTap: () => context.push('/category/crypto?name=${AppStrings.tr(AppStrings.catCrypto, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catStock, lc),
                  subtitle: AppStrings.tr(AppStrings.catStockDesc, lc),
                  icon: Icons.candlestick_chart,
                  color: AppColors.stock,
                  onTap: () => context.push('/category/stock?name=${AppStrings.tr(AppStrings.catStock, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catForex, lc),
                  subtitle: AppStrings.tr(AppStrings.catForexDesc, lc),
                  icon: Icons.currency_exchange,
                  color: AppColors.forex,
                  onTap: () => context.push('/category/forex?name=${AppStrings.tr(AppStrings.catForex, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catCommodity, lc),
                  subtitle: AppStrings.tr(AppStrings.catCommodityDesc, lc),
                  icon: Icons.diamond_outlined,
                  color: AppColors.commodity,
                  onTap: () => context.push('/category/commodity?name=${AppStrings.tr(AppStrings.catCommodity, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catFunds, lc),
                  subtitle: AppStrings.tr(AppStrings.catFundsDesc, lc),
                  icon: Icons.pie_chart_outline,
                  color: AppColors.etf,
                  onTap: () => context.push('/funds'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catBond, lc),
                  subtitle: AppStrings.tr(AppStrings.catBondDesc, lc),
                  icon: Icons.receipt_long,
                  color: AppColors.bond,
                  onTap: () => context.push('/category/bond?name=${AppStrings.tr(AppStrings.catBond, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catPension, lc),
                  subtitle: AppStrings.tr(AppStrings.catPensionDesc, lc),
                  icon: Icons.savings_outlined,
                  color: AppColors.success,
                  onTap: () => context.push('/category/pension_fund?name=${AppStrings.tr(AppStrings.catPension, lc)}'),
                ),
                _CategoryCard(
                  title: AppStrings.tr(AppStrings.catInsurance, lc),
                  subtitle: AppStrings.tr(AppStrings.catInsuranceDesc, lc),
                  icon: Icons.security,
                  color: AppColors.info,
                  onTap: () => context.push('/category/life_insurance?name=${AppStrings.tr(AppStrings.catInsurance, lc)}'),
                ),
              ]),
            ),
          ),
          
          const SliverPadding(padding: EdgeInsets.only(bottom: 24)),
        ],
      ),
    );
  }
}

class _MarketTickerWidget extends StatefulWidget {
  final String lc;
  const _MarketTickerWidget({required this.lc});

  @override
  State<_MarketTickerWidget> createState() => _MarketTickerWidgetState();
}

class _MarketTickerWidgetState extends State<_MarketTickerWidget> {
  late ScrollController _scrollController;
  late Timer _timer;
  final double _scrollSpeed = 1.0; 
  List<_TickerItem> _items = [];

  @override
  void initState() {
    super.initState();
    _scrollController = ScrollController();
    _items = _getDemoItems();
    _loadData();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _startAutoScroll();
    });
  }

